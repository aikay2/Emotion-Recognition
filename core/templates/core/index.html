<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Face Emotion Detector</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #e7edf9 0%, #d2d9f0 100%);
      color: #222;
    }

    .card {
      background: #fff;
      padding: 32px 40px;
      border-radius: 18px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 480px;
      text-align: center;
      transition: all 0.4s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-bottom: 24px;
      color: #1e3c72;
      font-weight: 600;
      font-size: 1.4rem;
    }

    label {
      display: block;
      text-align: left;
      margin: 10px 0 6px;
      font-weight: 500;
      color: #333;
    }

    input[type="text"],
    input[type="email"],
    input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: #1e3c72;
    }

    button {
      margin-top: 16px;
      padding: 12px 22px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: linear-gradient(135deg, #2a5298, #1e3c72);
    }

    .btn-alt {
      background: #f2f2f2;
      color: #1e3c72;
      border: 1px solid #ccc;
      margin-left: 6px;
    }

    .btn-alt:hover {
      background: #e5e8f0;
    }

    .result {
      padding: 24px;
      border-radius: 14px;
      background: #f4f7ff;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
      text-align: center;
      animation: fadeIn 0.7s ease forwards;
    }

    img.preview {
      max-width: 240px;
      border-radius: 10px;
      margin-top: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    #camera-section {
      margin-top: 14px;
      display: none;
    }

    video {
      width: 100%;
      border-radius: 12px;
      margin-top: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    canvas {
      display: none;
    }

    .fade-out {
      opacity: 0;
      pointer-events: none;
      height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
      transition: all 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>

<body>
  <div class="card" id="main-card">
    <h2>Emotion Detection Portal</h2>

    <form method="post" enctype="multipart/form-data" id="upload-form">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <label for="id_name">Full name</label>
      {{ form.name }}

      <label for="id_email">Email</label>
      {{ form.email }}

      <label for="id_image">Upload photo</label>
      {{ form.image }}

      <div style="margin-top:10px;">
        <button type="button" id="open-camera" class="btn-alt">Use Webcam</button>
      </div>

      <div id="camera-section">
        <video id="camera" autoplay></video><br>
        <button type="button" id="capture">Capture Photo</button>
        <canvas id="canvas"></canvas>
      </div>

      <button type="submit">Submit</button>
    </form>

    {% if result %}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('upload-form');
        form.classList.add('fade-out');
        setTimeout(() => form.style.display = 'none', 600);
      });
    </script>

    <div class="result" id="result-card">
      <h3>Detected Emotion:  {{ result.emoji }} {{ result.emotion }}</h3>
      <p>{{ result.message }}</p>
      <img class="preview" src="{{ result.image_url }}" alt="Uploaded image">
    </div>
    {% endif %}
  </div>

  <script>
    const openCamBtn = document.getElementById('open-camera');
    const cameraSection = document.getElementById('camera-section');
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture');
    const fileInput = document.querySelector('input[type="file"]');
    let stream;

    openCamBtn.addEventListener('click', async () => {
      cameraSection.style.display = 'block';
      openCamBtn.style.display = 'none';
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert('Could not access your camera.');
      }
    });

    captureBtn.addEventListener('click', () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        const file = new File([blob], "capture.png", { type: "image/png" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
      });
      // Stop camera
      stream.getTracks().forEach(track => track.stop());
      cameraSection.style.display = 'none';
      openCamBtn.style.display = 'inline-block';
      alert('Photo captured and attached. You can now submit.');
    });
  </script>
  <script>
    const form = document.getElementById('upload-form');
    const mainCard = document.getElementById('main-card');

    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // stop normal page reload

      const formData = new FormData(form);

      const response = await fetch("", {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      const data = await response.json();

      if (data.success) {
        form.classList.add('fade-out');
        setTimeout(() => form.style.display = 'none', 600);

        const resultDiv = document.createElement('div');
        resultDiv.classList.add('result');
        resultDiv.innerHTML = `
          <h3>Detected Emotion: ${data.emotion} ${data.emoji}</h3>
          <p>${data.message}</p>
          <img class="preview" src="${data.image_url}" alt="Uploaded image">
        `;
        mainCard.appendChild(resultDiv);
      } else {
        alert(data.error || "An error occurred.");
      }
    });
  </script>
</body>
</html>
